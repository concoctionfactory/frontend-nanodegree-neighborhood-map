var vm=null,yelp=function(){var a=function(){return Math.floor(1e12*Math.random()).toString()},b="http://api.yelp.com/v2/search",c={oauth_consumer_key:"c3k72t_lDi5ni3GVAnY5DA",oauth_token:"dkQ5ow9kZ70xbg-94TpFPyGWeaBAssPU",oauth_nonce:a(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",location:"Canal Street New York",term:"noodle tea ",limit:10},d="1Ab9HjsAQau_X4x02wncMmD-67w",e="cB4aqsRzJh8nKZRwKyy6FIDT_UQ",f=oauthSignature.generate("GET",b,c,d,e);c.oauth_signature=f;var g=setTimeout(function(){alert("yelp data was not successful")},8e3),h={url:b,data:c,cache:!0,dataType:"jsonp",success:function(a){var b=a.businesses;vm=new viewModel(b),ko.applyBindings(vm),clearTimeout(g)}};this.init=function(){$.ajax(h)}};(new yelp).init();var Place=function(a){this.name=ko.observable(a.name);var b=a.location.address[0]?a.location.address[0]+" ":"",c=a.location.address[1]?a.location.address[1]+" ":"",d=a.image_url.replace("ms","ls"),e=function(a,b){return b.some(function(b){for(var c in a)if(a[c].indexOf(b)>=0)return a[c].indexOf(b)>=0})};this.isBar=ko.observable(e(a.categories,["tea"])),this.address=ko.observable(b+c+a.location.city),this.location=ko.observable(a.location),this.image=ko.observable(d),this.maker=null,this.infowindow=null,this.phone=ko.observable(a.display_phone)},storage=function(a){localStorage.searchStore||(localStorage.searchStore=ko.toJSON("")),localStorage.currentStore||(localStorage.currentStore=ko.toJSON("")),this.searchStore=function(a){return a?void(localStorage.searchStore=ko.toJSON(a)):JSON.parse(localStorage.searchStore)},this.currentStr=function(a){if(!a)return JSON.parse(localStorage.currentStore);var b={name:a.name(),address:a.address(),phone:a.phone(),image:a.image()};localStorage.currentStore=ko.toJSON(b)}},viewModel=function(a){var b=this,c=new storage(b);if(b.placeList=ko.observableArray([]),a.forEach(function(a){b.placeList.push(new Place(a))}),b.filter=ko.observable(c.searchStore()),b.currentPlace=ko.observable(c.currentStr()),b.filterPlaces=ko.computed(function(){c.searchStore(b.filter());var a=b.filter().toLowerCase();if(a){var d=ko.utils.arrayFilter(b.placeList(),function(b){return b.name().toLowerCase().indexOf(a)!==-1});return 0===d.length&&c.searchStore(""),d}return b.placeList()}),b.setCurrent=function(a){b.currentPlace(a),c.currentStr(b.currentPlace()),d.markerShowInfo(a)},b.markerInfo=function(){b.setCurrent(this),b.hideShowMenu()},"undefined"!=typeof google){var d=new googleMaps(b);d.initMap()}else alert("google map data was not successful");b.hideShowMenu=function(){$(".menu").toggleClass("menu-hidden"),$(".thumbnail-section").toggleClass("thumbnail-section-hidden")}},googleMaps=function(a){var b,c=this,d=a.placeList(),e=a.filterPlaces();c.initMap=function(){b=new google.maps.Map(document.getElementById("map-canvas"),{zoom:12}),b.set("styles",[{featureType:"road.highway",elementType:"geometry",stylers:[{saturation:-100},{lightness:80}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{saturation:-100},{lightness:0}]},{featureType:"road.local",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"poi",elementType:"all",stylers:[{saturation:-100},{visibility:"off"}]},{featureType:"administrative",stylers:[{saturation:-100},{visibility:"off"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"water",elementType:"geometry",stylers:[{saturation:-100},{lightness:25},{visibility:"simplified"}]},{featureType:"road",stylers:[{saturation:-100},{lightness:-15},{visibility:"simplified"}]},{featureType:"landscape",stylers:[{saturation:-100},{lightness:70},{visibility:"simplified"}]}]);var e=new google.maps.Geocoder,f=new google.maps.LatLngBounds;c.geocodeAddress(e,f),google.maps.event.addDomListener(window,"resize",function(){var a=b.getCenter();google.maps.event.trigger(b,"resize"),b.setCenter(a)}),a.filterPlaces.subscribe(function(a){d.forEach(function(b){c.showMarker(b,c.checkShowMarker(b,a))})})},c.showMarker=function(a,c){c?a.marker.setMap(b):a.marker.setMap(null)},c.checkShowMarker=function(a,b){return jQuery.inArray(a,b)!==-1},c.geocodeAddress=function(a,f){d.forEach(function(d){a.geocode({address:d.address()},function(a,g){g===google.maps.GeocoderStatus.OK?(f.extend(a[0].geometry.location),c.createMarker(a[0],d,c.checkShowMarker(d,e))):alert("Geocode was not successful for the following reason: "+g),b.fitBounds(f)})})},c.createMarker=function(c,d,e){var f="./images/noun_154278_cc_1.png",g="./images/noun_82812_cc.png",h=d.isBar()?f:g,i=new google.maps.Marker({map:e?b:null,position:c.geometry.location,animation:google.maps.Animation.DROP,icon:h}),j="<div>"+d.name()+"</div",k=new google.maps.InfoWindow({content:j});d.marker=i,d.infowindow=k,i.addListener("click",function(){a.setCurrent(d)},i)},c.markerShowInfo=function(a){d.forEach(function(a){a.infowindow.close()}),a.infowindow.open(b,a.marker),a.marker.setAnimation(google.maps.Animation.DROP)}};